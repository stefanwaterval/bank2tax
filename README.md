# Bank2Tax

[![Build and Push Docker Image](https://github.com/stefanwaterval/bank2tax/actions/workflows/docker-publish.yml/badge.svg)](https://github.com/stefanwaterval/bank2tax/actions/workflows/docker-publish.yml)

Bank2Tax is a lightweight tool for extracting structured account information from end-of-the-year bank statements using OCR and large language models.
It converts PDF statements to Markdown, extracts account numbers and ending balances, and returns the results as structured JSON or via a simple web interface.
It can be used to simplify manual entry into tax softwares.

## Features

- PDF → Markdown conversion using Docling
- Structured extraction via local LLMs (Ollama)
- Web UI for interactive uploads (NiceGUI)
- CLI script for quick tests
- Optional saving of intermediate Markdown files for debug
  
⚠️ Bank2Tax is designed to extract ending balances only at this stage, not interest payments.

## Tested Banks

The app has been tested on the following bank statements:

| Bank / Institution | Language | Status |
|--------------------|----------|--------|
| Neon (CH)          | German   | ✅     |
| PostFinance (CH)   | German   | ✅     |

An EUR denominated PostFinance statement was also tested and was conclusive.

⚠️ Always verify extracted values before copy-pasting into your tax software. \
Results are generated by a large language model and may contain errors.

## Performance

Performance mainly depends on the selected Ollama model and available hardware.

The following timings were observed with `llama3.1:8b` on 1–3 documents:

- MacBook M3 Pro (run from source): **20-40 sec**
- Docker (CPU only): **100-120 sec**

## Architecture

```text
bank2tax/
|-- README.md
|-- pyproject.toml
|-- Dockerfile
|-- compose.yml
|
|-- bank2tax/
    |-- app/
    |   |-- web.py        # NiceGUI web UI entrypoint
    |   |-- cli.py        # CLI entrypoint
    |
    |-- core/
        |-- settings.py       # Configuration and environment loading
        |-- pipeline.py       # End-to-end extraction workflow
        |-- docling_io.py     # PDF -> Markdown conversion
        |-- schema.py         # Pydantic models for structured output
        |-- ollama_client.py  # Ollama HTTP client
        |-- extractor.py      # LLM extraction agent
```

### High-level Workflow

1. PDFs → Markdown via `docling_io.py`
2. Markdown → `ExtractorAgent`
3. `ExtractorAgent` → `OllamaClient` → Ollama
4. Ollama → JSON (schema-constrained)
5. JSON → validated into Pydantic models
6. Results exposed via Web UI or CLI

## Prerequisites

- Docker (for container-based usage) or Python
- Ollama installed locally
- At least one Ollama model pulled

Recommended model: `llama3.1:8b`

Other models tested: `mistral:7b`, not conclusive

## Install and Run

### Option 1 - Docker

Make sure you have Docker installed on your system.
Download the `compose.yaml` and run:

```bash
docker compose up -d
```

The image will be pulled automatically from Docker Hub.

No `.env` file required, environnement variables can be edited directly inside `compose.yaml`.

⚠️ Running with Docker can be 2-3 times slower.

### Option 2 - Run from source (Python)

Clone the repo.

Inside the repo, install dependencies:

```bash
uv sync
```

Create a `.env` file (optional) and configure:

```text
BANK2TAX_DATA_DIR=./data # Folder where your pdfs are
BANK2TAX_OUTPUT_DIR=./output # Folder where optional markdown outputs go

OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_MODEL=llama3.1:8b # Choose your favorite model
OLLAMA_TEMPERATURE=0.0
OLLAMA_TIMEOUT_S=120

SAVE_MD=0 # Set to 1 if you want to save markdowns (only in CLI mode)
```

#### Web Interface

Launch the NiceGUI web application:

```bash
uv run python -m bank2tax.app.web
```

This starts a local web UI where PDF files can be uploade directly.

#### CLI Mode

Run extraction from a folder of PDFs:

```bash
uv run python -m bank2tax.app.cli
```

PDFs are read from `BANK2TAX_DATA_DIR` (or `data/` by default).\
The CLI prints structured JSON to stdout.

### Notes

- Ollama must be running before launching the app
- Models must be pulled manually (e.g. `ollama pull llama3.1:8b`)
